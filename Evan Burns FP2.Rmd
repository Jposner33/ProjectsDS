---
title: "FP2"
author: "Evan Burns"
date: "`r Sys.Date()`"
output: html_document
---

```{r}
## Load the original dataset from Excel
library(openxlsx)
library(tidyverse)
test <- read.xlsx("~/Desktop/Senior Year Work/Projects In Data Science/Insurance Data/hhi01.xlsx")
raceandsex <- read.xlsx("~/Desktop/Senior Year Work/Projects In Data Science/Insurance Data/hhi01.xlsx", startRow = 4, rows = c(4,5:55,57:107,109:159,161:211,213:263,265:315,317:367,369:419, 421:471))

raceandsex$Year[raceandsex$Year == '2020 2'] <- 2020

colnames(raceandsex) <- make.names(colnames(raceandsex), unique = TRUE)

```

```{r}
## Divide the table into subtables based on the demographic studied

# The following list was generated by ChatGPT with the following prompt: *generate me a list with each letter of the alphabet represented by a single instance followed by 16 repeated instances, each separated by commas and enclosed in quotes* I added AA manually. 

raceandsex$Group <- c("A", "A", "A", "A", "A", "A", "A", "A", "A", "A", "A", "A", "A", "A", "A", "A", "A",  
"B", "B", "B", "B", "B", "B", "B", "B", "B", "B", "B", "B", "B", "B", "B", "B", "B",  
"C", "C", "C", "C", "C", "C", "C", "C", "C", "C", "C", "C", "C", "C", "C", "C", "C",  
"D", "D", "D", "D", "D", "D", "D", "D", "D", "D", "D", "D", "D", "D", "D", "D", "D",  
"E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E",  
"F", "F", "F", "F", "F", "F", "F", "F", "F", "F", "F", "F", "F", "F", "F", "F", "F",  
"G", "G", "G", "G", "G", "G", "G", "G", "G", "G", "G", "G", "G", "G", "G", "G", "G",  
"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",  
"I", "I", "I", "I", "I", "I", "I", "I", "I", "I", "I", "I", "I", "I", "I", "I", "I",  
"J", "J", "J", "J", "J", "J", "J", "J", "J", "J", "J", "J", "J", "J", "J", "J", "J",  
"K", "K", "K", "K", "K", "K", "K", "K", "K", "K", "K", "K", "K", "K", "K", "K", "K",  
"L", "L", "L", "L", "L", "L", "L", "L", "L", "L", "L", "L", "L", "L", "L", "L", "L",  
"M", "M", "M", "M", "M", "M", "M", "M", "M", "M", "M", "M", "M", "M", "M", "M", "M",  
"N", "N", "N", "N", "N", "N", "N", "N", "N", "N", "N", "N", "N", "N", "N", "N", "N",  
"O", "O", "O", "O", "O", "O", "O", "O", "O", "O", "O", "O", "O", "O", "O", "O", "O",  
"P", "P", "P", "P", "P", "P", "P", "P", "P", "P", "P", "P", "P", "P", "P", "P", "P",  
"Q", "Q", "Q", "Q", "Q", "Q", "Q", "Q", "Q", "Q", "Q", "Q", "Q", "Q", "Q", "Q", "Q",  
"R", "R", "R", "R", "R", "R", "R", "R", "R", "R", "R", "R", "R", "R", "R", "R", "R",  
"S", "S", "S", "S", "S", "S", "S", "S", "S", "S", "S", "S", "S", "S", "S", "S", "S",  
"T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T",  
"U", "U", "U", "U", "U", "U", "U", "U", "U", "U", "U", "U", "U", "U", "U", "U", "U",  
"V", "V", "V", "V", "V", "V", "V", "V", "V", "V", "V", "V", "V", "V", "V", "V", "V",  
"W", "W", "W", "W", "W", "W", "W", "W", "W", "W", "W", "W", "W", "W", "W", "W", "W",  
"X", "X", "X", "X", "X", "X", "X", "X", "X", "X", "X", "X", "X", "X", "X", "X", "X",  
"Y", "Y", "Y", "Y", "Y", "Y", "Y", "Y", "Y", "Y", "Y", "Y", "Y", "Y", "Y", "Y", "Y",  
"Z", "Z", "Z", "Z", "Z", "Z", "Z", "Z", "Z", "Z", "Z", "Z", "Z", "Z", "Z", "Z", "Z",
"AA", "AA", "AA", "AA", "AA", "AA", "AA", "AA", "AA", "AA", "AA", "AA", "AA", "AA", "AA", "AA", "AA")

split_tables <- raceandsex %>%
  group_split(Group)

tables_list <- list()

for (i in seq_along(split_tables)) {
  group_name <- unique(split_tables[[i]]$Group)
  tables_list[[group_name]] <- split_tables[[i]]
}

for (name in names(tables_list)) {
  cat(paste("Data Frame for Group", name, ":\n"))
  print(tables_list[[name]])
  cat("\n")
}

final_tables_list <- list()

for (i in seq_along(tables_list)) {
  current_table <- tables_list[[i]]
  new_name <- as.character(current_table[1,1])
  current_table <- current_table[-1, ]
  final_tables_list[[new_name]] <- current_table
}

for (name in names(final_tables_list)) {
  assign(name, final_tables_list[[name]], envir = .GlobalEnv)
}
```

```{r}
## Divide the subtables into number and percent parts

first_part_tables <- list()
second_part_tables <- list()

for (name in names(final_tables_list)) {
  current_table <- final_tables_list[[name]]
  first_part <- current_table[2:8, ]
  second_part <- current_table[-(1:9), ]
    first_part_tables[[name]] <- first_part
  second_part_tables[[name]] <- second_part
  assign(paste0(name, "_first_part"), first_part, envir = .GlobalEnv)
  assign(paste0(name, "_second_part"), second_part, envir = .GlobalEnv)
}
```

```{r}
# Rejoin the two parts together and have both subsets stored under the same year

joined_tables <- list()

for (name in names(final_tables_list)) {
  first_part <- get(paste0(name, "_first_part"))
  second_part <- get(paste0(name, "_second_part"))
  joined_table <- left_join(first_part, second_part, by = "Year")
    joined_tables[[name]] <- joined_table
    assign(paste0(name, "_joined"), joined_table, envir = .GlobalEnv)
}
```

```{r}
# Create one table with all subsets
combined_table <- get(paste0(names(final_tables_list)[1], "_joined"))

for (i in 2:length(final_tables_list)) {
  next_table <- get(paste0(names(final_tables_list)[i], "_joined"))
  combined_table <- left_join(combined_table, next_table, by = "Year")
}

assign("final_combined_table", combined_table, envir = .GlobalEnv)

combined_table <- combined_table %>%
  select(-contains("group"))
```

```{r}
## Remove all unneccessary tables

objects_to_keep <- c("combined_table", "raceandsex")

rm(list = setdiff(ls(), objects_to_keep))
```

```{r}
# Renaming

current_colnames <- colnames(combined_table)

new_colnames <- current_colnames
new_colnames[2:length(current_colnames)] <- gsub("\\..*", "", current_colnames[2:length(current_colnames)])
colnames(combined_table) <- new_colnames

current_colnames <- colnames(combined_table)[-1]
new_colnames <- character(length(current_colnames))
for (i in seq_along(current_colnames)) {
  prefix <- ceiling(i / 22)
  new_colnames[i] <- paste0(prefix, ". ", current_colnames[i])
}

colnames(combined_table)[-1] <- new_colnames

start_row <- 596
current_colnames <- colnames(combined_table)[start_row:length(colnames(combined_table))]

new_colnames <- character(length(current_colnames))

colnames(combined_table) <- make.unique(make.names(colnames(combined_table)))
```

```{r fig.alt = "Percent of Asians, Blacks, Whites, and Hispanics (as well as all races) with health insurance in the US from 2017-2023"}
library(ggplot2)


ggplot(combined_table) +
  #All Races
  geom_point(aes(x = Year, y = X2..Any_insurance, color = "#F7CAC9")) +
  #White
  geom_point(aes(x = Year, y = X10..Any_insurance, color = "#88B04B")) +
  #Black
  geom_point(aes(x = Year, y = X28..Any_insurance, color = "#58A8D1")) +
  #Asian
  geom_point(aes(x = Year, y = X40..Any_insurance, color = "#6B5B93")) +
  #Hispanic
  geom_point(aes(x = Year, y = X52..Any_insurance, color = "#FF6F61")) +
  
  scale_color_manual(values = c("#FF6F61", "#6B5B93", "#88B04B", "#F7CAC9", "#58A8D1"), labels = c("Black", "Asian", "White", "All Races", "Hispanic")) +
  labs(y = "Percent of Demographic With Health Insurance") +
  theme_minimal()
```

This graph shows the percent of Asians, Blacks, Whites, and Hispanics with health insurance in the US from 2017-2023. Each group fluctuates a little, but stays pretty constant. The most important take away from this graph is that there are large differences in the percentage of the demographic with health insurance across different races. Most notably, Hispanics have the lowest percentage of healthcare in the low 80 percents. Next steps would be to dive into what is driving the difference in health insurance access for different races. 


